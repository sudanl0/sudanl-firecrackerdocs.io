<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Defines the metrics system."><title>vmm::logger::metrics - Rust</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/SourceSerif4-Regular-46f98efaafac5295.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/FiraSans-Regular-018c141bf0843ffd.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/FiraSans-Medium-8f9a781e4970d388.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/SourceCodePro-Regular-562dcc5011b6de7d.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/SourceCodePro-Semibold-d899c5a5c4aeb14a.ttf.woff2"><link rel="stylesheet" href="../../../static.files/normalize-76eba96aa4d2e634.css"><link rel="stylesheet" href="../../../static.files/rustdoc-4e54bb2b497cc83f.css"><meta name="rustdoc-vars" data-root-path="../../../" data-static-root-path="../../../static.files/" data-current-crate="vmm" data-themes="" data-resource-suffix="" data-rustdoc-version="1.77.0-nightly (a2d9d73e6 2024-01-10)" data-channel="nightly" data-search-js="search-dd67cee4cfa65049.js" data-settings-js="settings-4313503d2e1961c2.js" ><script src="../../../static.files/storage-f2adc0d6ca4d09fb.js"></script><script defer src="../sidebar-items.js"></script><script defer src="../../../static.files/main-0b2e2def73e61cbe.js"></script><noscript><link rel="stylesheet" href="../../../static.files/noscript-04d5337699b92874.css"></noscript><link rel="alternate icon" type="image/png" href="../../../static.files/favicon-16x16-8b506e7a72182f1c.png"><link rel="alternate icon" type="image/png" href="../../../static.files/favicon-32x32-422f7d1d52889060.png"><link rel="icon" type="image/svg+xml" href="../../../static.files/favicon-2c020d218678b618.svg"></head><body class="rustdoc mod"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle" title="show sidebar"></button></nav><nav class="sidebar"><div class="sidebar-crate"><h2><a href="../../../vmm/index.html">vmm</a><span class="version">0.1.0</span></h2></div><h2 class="location"><a href="#">Module metrics</a></h2><div class="sidebar-elems"><section><ul class="block"><li><a href="#macros">Macros</a></li><li><a href="#structs">Structs</a></li><li><a href="#enums">Enums</a></li><li><a href="#constants">Constants</a></li><li><a href="#statics">Statics</a></li><li><a href="#traits">Traits</a></li></ul></section><h2><a href="../index.html">In vmm::logger</a></h2></div></nav><div class="sidebar-resizer"></div>
    <main><div class="width-limiter"><nav class="sub"><form class="search-form"><span></span><div id="sidebar-button" tabindex="-1"><a href="../../../vmm/all.html" title="show sidebar"></a></div><input class="search-input" name="search" aria-label="Run search in the documentation" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><div id="help-button" tabindex="-1"><a href="../../../help.html" title="help">?</a></div><div id="settings-menu" tabindex="-1"><a href="../../../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../../../static.files/wheel-7b819b6101059cd0.svg"></a></div></form></nav><section id="main-content" class="content"><div class="main-heading"><h1>Module <a href="../../index.html">vmm</a>::<wbr><a href="../index.html">logger</a>::<wbr><a class="mod" href="#">metrics</a><button id="copy-path" title="Copy item path to clipboard"><img src="../../../static.files/clipboard-7571035ce49a181d.svg" width="19" height="18" alt="Copy item path"></button></h1><span class="out-of-band"><a class="src" href="../../../src/vmm/logger/metrics.rs.html#4-1067">source</a> · <button id="toggle-all-docs" title="collapse all docs">[<span>&#x2212;</span>]</button></span></div><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>Defines the metrics system.</p>
<h2 id="metrics-format"><a href="#metrics-format">Metrics format</a></h2>
<p>The metrics are flushed in JSON format each 60 seconds. The first field will always be the
timestamp followed by the JSON representation of the structures representing each component on
which we are capturing specific metrics.</p>
<h3 id="json-example-with-metrics"><a href="#json-example-with-metrics">JSON example with metrics:</a></h3><div class="example-wrap"><pre class="language-json"><code>{
 &quot;utc_timestamp_ms&quot;: 1541591155180,
 &quot;api_server&quot;: {
   &quot;process_startup_time_us&quot;: 0,
   &quot;process_startup_time_cpu_us&quot;: 0
 },
 &quot;block&quot;: {
   &quot;activate_fails&quot;: 0,
   &quot;cfg_fails&quot;: 0,
   &quot;event_fails&quot;: 0,
   &quot;flush_count&quot;: 0,
   &quot;queue_event_count&quot;: 0,
   &quot;read_count&quot;: 0,
   &quot;write_count&quot;: 0
 }
}
</code></pre></div>
<p>The example above means that inside the structure representing all the metrics there is a field
named <code>block</code> which is in turn a serializable child structure collecting metrics for
the block device such as <code>activate_fails</code>, <code>cfg_fails</code>, etc.</p>
<h2 id="limitations"><a href="#limitations">Limitations</a></h2>
<p>Metrics are only written to buffers.</p>
<h2 id="design"><a href="#design">Design</a></h2>
<p>The main design goals of this system are:</p>
<ul>
<li>Use lockless operations, preferably ones that don’t require anything other than simple
reads/writes being atomic.</li>
<li>Exploit interior mutability and atomics being Sync to allow all methods (including the ones
which are effectively mutable) to be callable on a global non-mut static.</li>
<li>Rely on <code>serde</code> to provide the actual serialization for writing the metrics.</li>
<li>Since all metrics start at 0, we implement the <code>Default</code> trait via derive for all of them, to
avoid having to initialize everything by hand.</li>
</ul>
<p>The system implements 2 types of metrics:</p>
<ul>
<li>Shared Incremental Metrics (SharedIncMetrics) - dedicated for the metrics which need a counter
(i.e the number of times an API request failed). These metrics are reset upon flush.</li>
<li>Shared Store Metrics (SharedStoreMetrics) - are targeted at keeping a persistent value, it is
not
intended to act as a counter (i.e for measure the process start up time for example).</li>
</ul>
<p>The current approach for the <code>SharedIncMetrics</code> type is to store two values (current and
previous) and compute the delta between them each time we do a flush (i.e by serialization).
There are a number of advantages to this approach, including:</p>
<ul>
<li>We don’t have to introduce an additional write (to reset the value) from the thread which does
to actual writing, so less synchronization effort is required.</li>
<li>We don’t have to worry at all that much about losing some data if writing fails for a while
(this could be a concern, I guess).
If if turns out this approach is not really what we want, it’s pretty easy to resort to
something else, while working behind the same interface.</li>
</ul>
</div></details><h2 id="macros" class="section-header"><a href="#macros">Macros</a></h2><ul class="item-table"><li><div class="item-name"><a class="macro" href="macro.create_serialize_proxy.html" title="macro vmm::logger::metrics::create_serialize_proxy">create_serialize_proxy</a><span title="Restricted Visibility">&nbsp;🔒</span> </div></li></ul><h2 id="structs" class="section-header"><a href="#structs">Structs</a></h2><ul class="item-table"><li><div class="item-name"><a class="struct" href="struct.ApiServerMetrics.html" title="struct vmm::logger::metrics::ApiServerMetrics">ApiServerMetrics</a></div><div class="desc docblock-short">Metrics related to the internal API server.</div></li><li><div class="item-name"><a class="struct" href="struct.BalloonMetricsSerializeProxy.html" title="struct vmm::logger::metrics::BalloonMetricsSerializeProxy">BalloonMetricsSerializeProxy</a></div></li><li><div class="item-name"><a class="struct" href="struct.BlockMetricsSerializeProxy.html" title="struct vmm::logger::metrics::BlockMetricsSerializeProxy">BlockMetricsSerializeProxy</a></div></li><li><div class="item-name"><a class="struct" href="struct.DeprecatedApiMetrics.html" title="struct vmm::logger::metrics::DeprecatedApiMetrics">DeprecatedApiMetrics</a></div><div class="desc docblock-short">Metrics related to deprecated user-facing API calls.</div></li><li><div class="item-name"><a class="struct" href="struct.EntropyMetricsSerializeProxy.html" title="struct vmm::logger::metrics::EntropyMetricsSerializeProxy">EntropyMetricsSerializeProxy</a></div></li><li><div class="item-name"><a class="struct" href="struct.FirecrackerMetrics.html" title="struct vmm::logger::metrics::FirecrackerMetrics">FirecrackerMetrics</a></div><div class="desc docblock-short">Structure storing all metrics while enforcing serialization support on them.</div></li><li><div class="item-name"><a class="struct" href="struct.GetRequestsMetrics.html" title="struct vmm::logger::metrics::GetRequestsMetrics">GetRequestsMetrics</a></div><div class="desc docblock-short">Metrics specific to GET API Requests for counting user triggered actions and/or failures.</div></li><li><div class="item-name"><a class="struct" href="struct.LatencyAggregateMetrics.html" title="struct vmm::logger::metrics::LatencyAggregateMetrics">LatencyAggregateMetrics</a></div><div class="desc docblock-short">Used to record Aggregate (min/max/sum) of latency metrics</div></li><li><div class="item-name"><a class="struct" href="struct.LatencyMetricsRecorder.html" title="struct vmm::logger::metrics::LatencyMetricsRecorder">LatencyMetricsRecorder</a></div><div class="desc docblock-short">Provides efficient way to record LatencyAggregateMetrics</div></li><li><div class="item-name"><a class="struct" href="struct.LegacyDevMetricsSerializeProxy.html" title="struct vmm::logger::metrics::LegacyDevMetricsSerializeProxy">LegacyDevMetricsSerializeProxy</a></div></li><li><div class="item-name"><a class="struct" href="struct.LoggerSystemMetrics.html" title="struct vmm::logger::metrics::LoggerSystemMetrics">LoggerSystemMetrics</a></div><div class="desc docblock-short">Metrics for the logging subsystem.</div></li><li><div class="item-name"><a class="struct" href="struct.Metrics.html" title="struct vmm::logger::metrics::Metrics">Metrics</a></div><div class="desc docblock-short">Metrics system.</div></li><li><div class="item-name"><a class="struct" href="struct.MmdsMetrics.html" title="struct vmm::logger::metrics::MmdsMetrics">MmdsMetrics</a></div><div class="desc docblock-short">Metrics for the MMDS functionality.</div></li><li><div class="item-name"><a class="struct" href="struct.NetMetricsSerializeProxy.html" title="struct vmm::logger::metrics::NetMetricsSerializeProxy">NetMetricsSerializeProxy</a></div></li><li><div class="item-name"><a class="struct" href="struct.PatchRequestsMetrics.html" title="struct vmm::logger::metrics::PatchRequestsMetrics">PatchRequestsMetrics</a></div><div class="desc docblock-short">Metrics specific to PATCH API Requests for counting user triggered actions and/or failures.</div></li><li><div class="item-name"><a class="struct" href="struct.PerformanceMetrics.html" title="struct vmm::logger::metrics::PerformanceMetrics">PerformanceMetrics</a></div><div class="desc docblock-short">Performance metrics related for the moment only to snapshots.</div></li><li><div class="item-name"><a class="struct" href="struct.ProcessTimeReporter.html" title="struct vmm::logger::metrics::ProcessTimeReporter">ProcessTimeReporter</a></div><div class="desc docblock-short">Reporter object which computes the process wall time and
process CPU time and populates the metric with the results.</div></li><li><div class="item-name"><a class="struct" href="struct.PutRequestsMetrics.html" title="struct vmm::logger::metrics::PutRequestsMetrics">PutRequestsMetrics</a></div><div class="desc docblock-short">Metrics specific to PUT API Requests for counting user triggered actions and/or failures.</div></li><li><div class="item-name"><a class="struct" href="struct.SeccompMetrics.html" title="struct vmm::logger::metrics::SeccompMetrics">SeccompMetrics</a></div><div class="desc docblock-short">Metrics for the seccomp filtering.</div></li><li><div class="item-name"><a class="struct" href="struct.SerializeToUtcTimestampMs.html" title="struct vmm::logger::metrics::SerializeToUtcTimestampMs">SerializeToUtcTimestampMs</a><span title="Restricted Visibility">&nbsp;🔒</span> </div></li><li><div class="item-name"><a class="struct" href="struct.SharedIncMetric.html" title="struct vmm::logger::metrics::SharedIncMetric">SharedIncMetric</a></div><div class="desc docblock-short">Representation of a metric that is expected to be incremented from more than one thread, so more
synchronization is necessary.</div></li><li><div class="item-name"><a class="struct" href="struct.SharedStoreMetric.html" title="struct vmm::logger::metrics::SharedStoreMetric">SharedStoreMetric</a></div><div class="desc docblock-short">Representation of a metric that is expected to hold a value that can be accessed
from more than one thread, so more synchronization is necessary.</div></li><li><div class="item-name"><a class="struct" href="struct.SignalMetrics.html" title="struct vmm::logger::metrics::SignalMetrics">SignalMetrics</a></div><div class="desc docblock-short">Metrics related to signals.
Deadly signals must be of <code>SharedStoreMetric</code> type, since they can ever be either 0 or 1.
This avoids a tricky race condition caused by the unatomic serialize method of
<code>SharedIncMetric</code>, between two threads calling <code>METRICS.write()</code>.</div></li><li><div class="item-name"><a class="struct" href="struct.VcpuMetrics.html" title="struct vmm::logger::metrics::VcpuMetrics">VcpuMetrics</a></div><div class="desc docblock-short">Structure provides Metrics specific to VCPUs’ mode of functioning.
Sample_count or number of kvm exits for IO and MMIO VM exits are covered by:
<code>exit_io_in</code>, <code>exit_io_out</code>, <code>exit_mmio_read</code> and , <code>exit_mmio_write</code>.
Count of other vm exits for events like shutdown/hlt/errors are
covered by existing “failures” metric.
The only vm exit for which sample_count is not covered is system
event reset/shutdown but that should be fine since they are not
failures and the vm is terminated anyways.
LatencyAggregateMetrics only covers minimum, maximum and sum
because average can be deduced from available metrics. e.g.
dividing <code>exit_io_in_agg.sum_us</code> by exit_io_in` gives average of KVM exits handling input IO.</div></li><li><div class="item-name"><a class="struct" href="struct.VhostUserMetricsSerializeProxy.html" title="struct vmm::logger::metrics::VhostUserMetricsSerializeProxy">VhostUserMetricsSerializeProxy</a></div></li><li><div class="item-name"><a class="struct" href="struct.VmmMetrics.html" title="struct vmm::logger::metrics::VmmMetrics">VmmMetrics</a></div><div class="desc docblock-short">Metrics specific to the machine manager as a whole.</div></li><li><div class="item-name"><a class="struct" href="struct.VsockMetricsSerializeProxy.html" title="struct vmm::logger::metrics::VsockMetricsSerializeProxy">VsockMetricsSerializeProxy</a></div></li></ul><h2 id="enums" class="section-header"><a href="#enums">Enums</a></h2><ul class="item-table"><li><div class="item-name"><a class="enum" href="enum.MetricsError.html" title="enum vmm::logger::metrics::MetricsError">MetricsError</a></div><div class="desc docblock-short">Describes the errors which may occur while handling metrics scenarios.</div></li></ul><h2 id="constants" class="section-header"><a href="#constants">Constants</a></h2><ul class="item-table"><li><div class="item-name"><a class="constant" href="constant._DERIVE_Display_FOR_MetricsError.html" title="constant vmm::logger::metrics::_DERIVE_Display_FOR_MetricsError">_DERIVE_Display_FOR_MetricsError</a><span title="Restricted Visibility">&nbsp;🔒</span> </div></li></ul><h2 id="statics" class="section-header"><a href="#statics">Statics</a></h2><ul class="item-table"><li><div class="item-name"><a class="static" href="static.METRICS.html" title="static vmm::logger::metrics::METRICS">METRICS</a></div><div class="desc docblock-short">Static instance used for handling metrics.</div></li></ul><h2 id="traits" class="section-header"><a href="#traits">Traits</a></h2><ul class="item-table"><li><div class="item-name"><a class="trait" href="trait.IncMetric.html" title="trait vmm::logger::metrics::IncMetric">IncMetric</a></div><div class="desc docblock-short">Used for defining new types of metrics that act as a counter (i.e they are continuously updated
by incrementing their value).</div></li><li><div class="item-name"><a class="trait" href="trait.StoreMetric.html" title="trait vmm::logger::metrics::StoreMetric">StoreMetric</a></div><div class="desc docblock-short">Used for defining new types of metrics that do not need a counter and act as a persistent
indicator.</div></li></ul></section></div></main></body></html>